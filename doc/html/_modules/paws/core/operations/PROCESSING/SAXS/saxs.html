<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>paws.core.operations.PROCESSING.SAXS.saxs &#8212; paws 0.4.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../../',
        VERSION:     '0.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">paws 0.4.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../operations.html" accesskey="U">paws.core.operations</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for paws.core.operations.PROCESSING.SAXS.saxs</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">remove</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interp</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">...operation</span> <span class="k">import</span> <span class="n">Operation</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="k">import</span> <span class="n">optools</span>

<span class="n">reference_loc</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;slacx&#39;</span><span class="p">,</span><span class="s1">&#39;slacxcore&#39;</span><span class="p">,</span><span class="s1">&#39;operations&#39;</span><span class="p">,</span><span class="s1">&#39;DMZ&#39;</span><span class="p">,</span><span class="s1">&#39;references&#39;</span><span class="p">,</span><span class="s1">&#39;polydispersity_guess_references.pickle&#39;</span><span class="p">)</span>
<span class="k">global</span> <span class="n">references</span>
<span class="n">references</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="GenerateSphericalDiffraction"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.GenerateSphericalDiffraction">[docs]</a><span class="k">class</span> <span class="nc">GenerateSphericalDiffraction</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a SAXS diffraction pattern for spherical nanoparticles.</span>

<span class="sd">    Uses r0 in real units and, if asked to generate q, gives q in real units.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r0&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_r_over_r0&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity_at_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;use_q_space&#39;</span><span class="p">,</span> <span class="s1">&#39;input_vector&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;location_vector&#39;</span><span class="p">,</span> <span class="s1">&#39;space&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GenerateSphericalDiffraction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mean particle radius; irrelevant if computing in x-space&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;sigma_r_over_r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;width of distribution in r divided by r0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;intensity_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;intensity at q = 0 / x = 0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;use_q_space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*True* if *input_vector* and/or *min*/*max*/*step* are values in q space; *False* if they are values in x space&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;input_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;q or x values of interest, if known.  Use *None* to generate a vector from *min*/*max*/*step* instead.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;minimum q or x value of interest&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;maximum q or x value of interest&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;step size in q or x values of interest&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; intensity values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;location_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; x or q values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&quot;x&quot; or &quot;q&quot;&#39;</span>
        <span class="c1"># source &amp; type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;sigma_r_over_r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;intensity_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;use_q_space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;input_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;use_q_space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">bool_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;use_q_space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="GenerateSphericalDiffraction.run"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.GenerateSphericalDiffraction.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_vector&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_vector</span> <span class="o">=</span> <span class="n">gen_q_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_vector&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;location_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_vector</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;use_q_space&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">x_vector</span> <span class="o">=</span> <span class="n">input_vector</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;q&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_vector</span> <span class="o">=</span> <span class="n">input_vector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
        <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;intensity_at_zero&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">blur</span><span class="p">(</span><span class="n">x_vector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;sigma_r_over_r0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">9.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span></div></div>

<div class="viewcode-block" id="GenerateReferences"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.GenerateReferences">[docs]</a><span class="k">class</span> <span class="nc">GenerateReferences</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate metrics used for guessing diffraction pattern properties.</span>

<span class="sd">    DOES NOT STORE.  IS NOT AUTOMATICALLY AVAILABLE TO OTHER OPERATIONS.</span>

<span class="sd">    Use OverwriteReferences to store the resulting dictionary, if desired.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">,</span> <span class="s1">&#39;xmax&#39;</span><span class="p">,</span> <span class="s1">&#39;xstep&#39;</span><span class="p">,</span> <span class="s1">&#39;factormin&#39;</span><span class="p">,</span> <span class="s1">&#39;factormax&#39;</span><span class="p">,</span> <span class="s1">&#39;factorstep&#39;</span><span class="p">]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GenerateReferences</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
        <span class="c1"># Documentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lowest computed value of x; nuisance parameter&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;highest computed value of x; nuisance parameter&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;xstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;step size in x; nuisance parameter&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;factormin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lowest computed value of factor&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;factormax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;highest computed value of factor&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;factorstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;step size in factor&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dictionary of useful values&#39;</span>
        <span class="c1"># Source and type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;xstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;factormin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;factormax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;factorstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;xstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;factormin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;factormax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;factorstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">float_type</span>
        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.02</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;xstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.02</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;factormin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;factormax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">35.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;factorstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>

<div class="viewcode-block" id="GenerateReferences.run"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.GenerateReferences.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">gen_q_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;xstep&#39;</span><span class="p">])</span>
        <span class="n">factorVals</span> <span class="o">=</span> <span class="n">gen_q_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;factormin&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;factormax&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;factorstep&#39;</span><span class="p">])</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">generate_references</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factorVals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span></div></div>

<div class="viewcode-block" id="OverwriteReferences"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.OverwriteReferences">[docs]</a><span class="k">class</span> <span class="nc">OverwriteReferences</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store previously generated metrics used for guessing diffraction pattern properties.</span>

<span class="sd">    USE WITH CAUTION as it will OVERWRITE any existing reference file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OverwriteReferences</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
        <span class="c1"># Documentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dictionary of useful values generated by GenerateReferences&#39;</span>
        <span class="c1"># Source and type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="OverwriteReferences.run"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.OverwriteReferences.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">reference_loc</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">dump_references</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">])</span></div></div>

<div class="viewcode-block" id="FetchReferences"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.FetchReferences">[docs]</a><span class="k">class</span> <span class="nc">FetchReferences</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch previously generated and stored metrics used for guessing diffraction pattern properties.</span>

<span class="sd">    This function is for examination, and is not necessary for computation.</span>
<span class="sd">    The file in question is auto-fetched by operations that rely on it.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FetchReferences</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
        <span class="c1"># Documentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dictionary of useful values generated by GenerateReferences&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;INPUT.GUESSER&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="FetchReferences.run"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.FetchReferences.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_references</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;No reference file was found at the appropriate location.&quot;</span></div></div>

<div class="viewcode-block" id="GuessProperties"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.GuessProperties">[docs]</a><span class="k">class</span> <span class="nc">GuessProperties</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Guess the polydispersity, mean size, and amplitude of spherical diffraction pattern.</span>

<span class="sd">    Assumes the data have already been background subtracted, smoothed, and otherwise cleaned.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;dI&#39;</span><span class="p">]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_size&#39;</span><span class="p">,</span> <span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;qFirstDip&#39;</span><span class="p">,</span> <span class="s1">&#39;heightFirstDip&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmaScaledFirstDip&#39;</span><span class="p">,</span> <span class="s1">&#39;heightAtZero&#39;</span><span class="p">,</span> <span class="s1">&#39;dips&#39;</span><span class="p">,</span> <span class="s1">&#39;shoulders&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GuessProperties</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
        <span class="c1"># Documentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; wave vector values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; intensity values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; error estimate of intensity values; input None if no dI exists&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal distribution sigma divided by mean size&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mean size of particles&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;projected scattering amplitude at q=0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;qFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimated location in q of the first dip&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;heightFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimated intensity at the minimum of the first dip&#39;</span>
        <span class="c1">#self.output_doc[&#39;sigmaScaledFirstDip&#39;] = &#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;heightAtZero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimated intensity at q = 0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;dips&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;boolean vector, True where a candidate local minimum is&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;shoulders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;boolean vector, True where a candidate local maximum is&#39;</span>
        <span class="c1"># Source and type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>

<div class="viewcode-block" id="GuessProperties.run"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.GuessProperties.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span>
        <span class="n">fractional_variation</span><span class="p">,</span> <span class="n">qFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">sigmaScaledFirstDip</span><span class="p">,</span> <span class="n">heightAtZero</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span> <span class="o">=</span> \
            <span class="n">guess_polydispersity</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;qFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qFirstDip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;heightFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heightFirstDip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;sigmaScaledFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaScaledFirstDip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;heightAtZero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heightAtZero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;dips&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dips</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;shoulders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shoulders</span>
        <span class="n">mean_size</span> <span class="o">=</span> <span class="n">guess_size</span><span class="p">(</span><span class="n">fractional_variation</span><span class="p">,</span> <span class="n">qFirstDip</span><span class="p">)</span>
        <span class="n">amplitude_at_zero</span> <span class="o">=</span> <span class="n">polydispersity_metric_heightAtZero</span><span class="p">(</span><span class="n">qFirstDip</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="p">)</span>
        <span class="c1">#dips, shoulders = choose_dips_and_shoulders1(q, I, dI)</span>
        <span class="n">amplitude_at_zero</span><span class="p">,</span> <span class="n">mean_size</span><span class="p">,</span> <span class="n">fractional_variation</span> <span class="o">=</span> <span class="n">refine_guess</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">amplitude_at_zero</span><span class="p">,</span> <span class="n">mean_size</span><span class="p">,</span> <span class="n">fractional_variation</span><span class="p">,</span> <span class="n">qFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">fractional_variation</span><span class="p">,</span> <span class="n">mean_size</span><span class="p">,</span> <span class="n">amplitude_at_zero</span></div></div>

<div class="viewcode-block" id="OptimizeSphericalDiffractionFit"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.OptimizeSphericalDiffractionFit">[docs]</a><span class="k">class</span> <span class="nc">OptimizeSphericalDiffractionFit</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;From an initial guess, optimize r0, I0, and fractional_variation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;dI&#39;</span><span class="p">,</span> <span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_size&#39;</span><span class="p">,</span> <span class="s1">&#39;fractional_variation&#39;</span><span class="p">,</span><span class="s1">&#39;noise_term_allowed&#39;</span><span class="p">]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_size&#39;</span><span class="p">,</span> <span class="s1">&#39;fractional_variation&#39;</span><span class="p">,</span><span class="s1">&#39;noise_floor&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OptimizeSphericalDiffractionFit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
        <span class="c1"># Documentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; wave vector values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; intensity values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d ndarray; intensity error estimate&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimate of intensity at q=0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimate of mean particle size&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimate of normal distribution sigma divided by mean size&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_doc</span><span class="p">[</span><span class="s1">&#39;noise_term_allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;allow a fitted noise floor?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal distribution sigma divided by mean size&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mean particle size&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;projected intensity at q=0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc</span><span class="p">[</span><span class="s1">&#39;noise_floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;an arbitrary constant additive accounting for noise and undersubtraction&#39;</span>
        <span class="c1"># Source and type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">wf_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_src</span><span class="p">[</span><span class="s1">&#39;noise_term_allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">text_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_type</span><span class="p">[</span><span class="s1">&#39;noise_term_allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optools</span><span class="o">.</span><span class="n">bool_type</span>
        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;noise_term_allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="OptimizeSphericalDiffractionFit.run"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.OptimizeSphericalDiffractionFit.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dI&#39;</span><span class="p">]</span>
        <span class="n">I0_in</span><span class="p">,</span> <span class="n">r0_in</span><span class="p">,</span> <span class="n">frac_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">]</span>
        <span class="n">noise_allowed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;noise_term_allowed&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">noise_allowed</span><span class="p">:</span>
            <span class="n">noise_floor</span> <span class="o">=</span> <span class="n">guess_noise_floor</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">r0_in</span><span class="p">)</span>
            <span class="c1">#noise_floor = guess_noise_floor(q, I, I0_in, r0_in, frac_in)</span>
            <span class="c1">#print &quot;initial guess for noise floor is&quot;, noise_floor</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> \
                <span class="n">curve_fit</span><span class="p">(</span><span class="n">generate_spherical_diffraction_plus_floor</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="p">[</span><span class="n">I0_in</span><span class="p">,</span> <span class="n">r0_in</span><span class="p">,</span> <span class="n">frac_in</span><span class="p">,</span> <span class="n">noise_floor</span><span class="p">],</span> <span class="n">dI</span><span class="p">,</span>
                          <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="n">I0_in</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r0_in</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frac_in</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">noise_floor</span><span class="o">*</span><span class="mf">0.5</span><span class="p">],</span>
                                  <span class="p">[</span><span class="n">I0_in</span><span class="o">/</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r0_in</span><span class="o">/</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frac_in</span><span class="o">/</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">noise_floor</span><span class="o">/</span><span class="mf">0.5</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;noise_floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1">#print &quot;final guess for noise floor is&quot;, self.outputs[&#39;noise_floor&#39;]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;noise_floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> \
                <span class="n">curve_fit</span><span class="p">(</span><span class="n">generate_spherical_diffraction</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="p">[</span><span class="n">I0_in</span><span class="p">,</span> <span class="n">r0_in</span><span class="p">,</span> <span class="n">frac_in</span><span class="p">],</span> <span class="n">dI</span><span class="p">,</span>
                          <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="n">I0_in</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r0_in</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frac_in</span><span class="o">*</span><span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="n">I0_in</span><span class="o">/</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r0_in</span><span class="o">/</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frac_in</span><span class="o">/</span><span class="mf">0.1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;amplitude_at_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;mean_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;fractional_variation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div></div>


<span class="c1"># I/O functions</span>

<div class="viewcode-block" id="prep_for_pickle"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.prep_for_pickle">[docs]</a><span class="k">def</span> <span class="nf">prep_for_pickle</span><span class="p">(</span><span class="n">factorVals</span><span class="p">,</span> <span class="n">xFirstDip</span><span class="p">,</span> <span class="n">sigmaScaledFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">heightAtZero</span><span class="p">):</span>
    <span class="n">references</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">references</span><span class="p">[</span><span class="s1">&#39;factorVals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">factorVals</span>
    <span class="n">references</span><span class="p">[</span><span class="s1">&#39;xFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xFirstDip</span>
    <span class="n">references</span><span class="p">[</span><span class="s1">&#39;heightFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heightFirstDip</span>
    <span class="n">references</span><span class="p">[</span><span class="s1">&#39;sigmaScaledFirstDip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaScaledFirstDip</span>
    <span class="n">references</span><span class="p">[</span><span class="s1">&#39;heightAtZero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heightAtZero</span>
    <span class="c1">#references[&#39;powerLaw&#39;] = powerLaw</span>
    <span class="k">return</span> <span class="n">references</span></div>

<div class="viewcode-block" id="load_references"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.load_references">[docs]</a><span class="k">def</span> <span class="nf">load_references</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reference_loc</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">references</span></div>

<div class="viewcode-block" id="dump_references"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.dump_references">[docs]</a><span class="k">def</span> <span class="nf">dump_references</span><span class="p">(</span><span class="n">references</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reference_loc</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">references</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span></div>

<span class="c1"># Functions about algebraic solutions</span>

<div class="viewcode-block" id="arbitrary_order_solution"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.arbitrary_order_solution">[docs]</a><span class="k">def</span> <span class="nf">arbitrary_order_solution</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Solves for a polynomial &quot;fit&quot; of arbitrary order.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">dy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Formulate the equation to be solved for polynomial coefficients</span>
    <span class="n">matrix</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">make_poly_matrices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="c1"># Solve equation</span>
    <span class="n">inverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inverse</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">coefficients</span></div>

<div class="viewcode-block" id="quadratic_extremum"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.quadratic_extremum">[docs]</a><span class="k">def</span> <span class="nf">quadratic_extremum</span><span class="p">(</span><span class="n">coefficients</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds the location in independent coordinate of the extremum of a quadratic equation.&#39;&#39;&#39;</span>
    <span class="n">extremum_location</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">extremum_location</span></div>

<div class="viewcode-block" id="polynomial_value"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.polynomial_value">[docs]</a><span class="k">def</span> <span class="nf">polynomial_value</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds the value of a polynomial at a location.&#39;&#39;&#39;</span>
    <span class="n">powers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coefficients</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="c1"># distinguish sequence x from numeric x</span>
        <span class="n">powers</span> <span class="o">=</span> <span class="n">horizontal</span><span class="p">(</span><span class="n">powers</span><span class="p">)</span>
        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">horizontal</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">vertical</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">**</span> <span class="n">powers</span><span class="p">)</span> <span class="o">*</span> <span class="n">coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">**</span> <span class="n">powers</span><span class="p">)</span> <span class="o">*</span> <span class="n">coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="vertical"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.vertical">[docs]</a><span class="k">def</span> <span class="nf">vertical</span><span class="p">(</span><span class="n">array1d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Turn 1d array into 2d vertical vector.&#39;&#39;&#39;</span>
    <span class="n">array1d</span> <span class="o">=</span> <span class="n">array1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">array1d</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">array1d</span></div>

<div class="viewcode-block" id="horizontal"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.horizontal">[docs]</a><span class="k">def</span> <span class="nf">horizontal</span><span class="p">(</span><span class="n">array1d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Turn 1d array into 2d horizontal vector.&#39;&#39;&#39;</span>
    <span class="n">array1d</span> <span class="o">=</span> <span class="n">array1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">array1d</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">array1d</span></div>

<div class="viewcode-block" id="dummy"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.dummy">[docs]</a><span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">array1d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Turn 1d array into dummy-index vector for 2d matrix computation.</span>

<span class="sd">    Sum over the dummy index by taking *object.sum(axis=0)*.&#39;&#39;&#39;</span>
    <span class="n">array1d</span> <span class="o">=</span> <span class="n">array1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">array1d</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">array1d</span></div>

<div class="viewcode-block" id="make_poly_matrices"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.make_poly_matrices">[docs]</a><span class="k">def</span> <span class="nf">make_poly_matrices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Make the matrices necessary to solve a polynomial fit of order *order*.</span>

<span class="sd">    :param x: 1d array representing independent variable</span>
<span class="sd">    :param y: 1d array representing dependent variable</span>
<span class="sd">    :param error: 1d array representing uncertainty in *y*</span>
<span class="sd">    :param order: integer order of polynomial fit</span>
<span class="sd">    :return matrix, vector: MC=V, where M is *matrix*, V is *vector*,</span>
<span class="sd">        and C is the polynomial coefficients to be solved for.</span>
<span class="sd">        *matrix* is an array of shape (order+1, order+1).</span>
<span class="sd">        *vector* is an array of shape (order+1, 1).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Arguments *x*, *y*, and *error* must all have the same shape.&#39;</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">dummy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">dummy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="n">vertical</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">dummy</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">index_block</span> <span class="o">=</span> <span class="n">horizontal</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="n">vertical</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">dummy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="n">index_block</span> <span class="o">*</span> <span class="n">dummy</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">vector</span></div>

<div class="viewcode-block" id="power_law_solution"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.power_law_solution">[docs]</a><span class="k">def</span> <span class="nf">power_law_solution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Solves for a power law by solving for a linear fit in log-log space.&#39;&#39;&#39;</span>
    <span class="c1"># Note that if dy is zeros, logdy will also be zeros, triggering default behavior in arbitrary_order_solution also.</span>
    <span class="k">if</span> <span class="n">dy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">logx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">logy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">logdy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="n">logLinearCoefficients</span> <span class="o">=</span> <span class="n">arbitrary_order_solution</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">logx</span><span class="p">,</span> <span class="n">logy</span><span class="p">,</span> <span class="n">logdy</span><span class="p">)</span>
    <span class="n">prefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logLinearCoefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">exponent</span> <span class="o">=</span> <span class="n">logLinearCoefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">powerCoefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">prefactor</span><span class="p">,</span> <span class="n">exponent</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">powerCoefficients</span></div>

<span class="c1"># Functions about simulating SAXS patterns</span>

<div class="viewcode-block" id="gen_q_vector"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.gen_q_vector">[docs]</a><span class="k">def</span> <span class="nf">gen_q_vector</span><span class="p">(</span><span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="p">,</span> <span class="n">qstep</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An inclusive-range version of np.arange.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="n">qmax</span> <span class="o">-</span> <span class="n">qmin</span><span class="p">),</span> <span class="n">qstep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">qmax</span> <span class="o">=</span> <span class="n">qmax</span> <span class="o">+</span> <span class="n">qstep</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="p">,</span> <span class="n">qstep</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="generate_spherical_diffraction"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.generate_spherical_diffraction">[docs]</a><span class="k">def</span> <span class="nf">generate_spherical_diffraction</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">r0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">*</span> <span class="n">blur</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span> <span class="o">*</span> <span class="mf">9.</span>
    <span class="k">return</span> <span class="n">i</span></div>

<div class="viewcode-block" id="fullFunction"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.fullFunction">[docs]</a><span class="k">def</span> <span class="nf">fullFunction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">x</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="gauss"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.gauss">[docs]</a><span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">sigma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**-</span><span class="mi">1</span> <span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="generateRhoFactor"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.generateRhoFactor">[docs]</a><span class="k">def</span> <span class="nf">generateRhoFactor</span><span class="p">(</span><span class="n">factor</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a guassian distribution of number densities (rho).</span>

<span class="sd">    :param factor: float</span>
<span class="sd">    :return:</span>

<span class="sd">    factor should be 0.1 for a sigma 10% of size</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">factorCenter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">factorMin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">factorCenter</span><span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
    <span class="n">factorMax</span> <span class="o">=</span> <span class="n">factorCenter</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">factor</span>
    <span class="n">factorVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">factorMin</span><span class="p">,</span> <span class="n">factorMax</span><span class="p">,</span> <span class="n">factor</span><span class="o">*</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">rhoVals</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">factorVals</span><span class="p">,</span> <span class="n">factorCenter</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">factorVals</span><span class="p">,</span> <span class="n">rhoVals</span></div>

<div class="viewcode-block" id="factorStretched"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.factorStretched">[docs]</a><span class="k">def</span> <span class="nf">factorStretched</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
    <span class="n">effective_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">factor</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">fullFunction</span><span class="p">(</span><span class="n">effective_x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="blur"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.blur">[docs]</a><span class="k">def</span> <span class="nf">blur</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
    <span class="n">factorVals</span><span class="p">,</span> <span class="n">rhoVals</span> <span class="o">=</span> <span class="n">generateRhoFactor</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
    <span class="n">deltaFactor</span> <span class="o">=</span> <span class="n">factorVals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">factorVals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ysum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">factorVals</span><span class="p">)):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">factorStretched</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factorVals</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">ysum</span> <span class="o">+=</span> <span class="n">rhoVals</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">deltaFactor</span>
    <span class="k">return</span> <span class="n">ysum</span></div>

<div class="viewcode-block" id="generate_references"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.generate_references">[docs]</a><span class="k">def</span> <span class="nf">generate_references</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factorVals</span><span class="p">):</span>
    <span class="c1">#y0 = fullFunction(x)</span>
    <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">factorVals</span><span class="p">)</span>
    <span class="n">xFirstDip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_tests</span><span class="p">)</span>
    <span class="n">sigmaScaledFirstDip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_tests</span><span class="p">)</span>
    <span class="n">heightFirstDip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_tests</span><span class="p">)</span>
    <span class="n">heightAtZero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_tests</span><span class="p">)</span>
    <span class="c1">#powerLawAll = np.zeros((num_tests, 2))</span>
    <span class="c1">#powerLawInitial = np.zeros((num_tests, 2))</span>
    <span class="c1">#depthFirstDip = np.zeros(num_tests)</span>
    <span class="c1">#y_x4_inf = np.zeros(num_tests)</span>
    <span class="c1">#lowQApprox = np.zeros((num_tests, 2))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factorVals</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
        <span class="n">xFirstDip</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">heightFirstDip</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">sigmaScaledFirstDip</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">heightAtZero</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">take_polydispersity_metrics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">prep_for_pickle</span><span class="p">(</span><span class="n">factorVals</span><span class="p">,</span> <span class="n">xFirstDip</span><span class="p">,</span> <span class="n">sigmaScaledFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">heightAtZero</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">references</span></div>

<span class="c1"># Funtions specifically about detecting SAXS properties</span>

<div class="viewcode-block" id="guess_polydispersity"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.guess_polydispersity">[docs]</a><span class="k">def</span> <span class="nf">guess_polydispersity</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1">#    global references</span>
    <span class="k">if</span> <span class="n">dI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span> <span class="o">=</span> <span class="n">choose_dips_and_shoulders</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="p">)</span>
    <span class="n">qFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">sigmaScaledFirstDip</span><span class="p">,</span> <span class="n">heightAtZero</span> <span class="o">=</span> <span class="n">take_polydispersity_metrics</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">qFirstDip</span> <span class="o">/</span> <span class="n">sigmaScaledFirstDip</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">heightFirstDip</span> <span class="o">/</span> <span class="n">heightAtZero</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">load_references</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">no_reference_message</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;xFirstDip&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;sigmaScaledFirstDip&#39;</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;heightFirstDip&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;heightAtZero&#39;</span><span class="p">]</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;factorVals&#39;</span><span class="p">]</span>
    <span class="n">fractional_variation</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">best_xy</span> <span class="o">=</span> <span class="n">guess_nearest_point_on_nonmonotonic_trace_normalized</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">factor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fractional_variation</span><span class="p">,</span> <span class="n">qFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">sigmaScaledFirstDip</span><span class="p">,</span> <span class="n">heightAtZero</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span></div>

<div class="viewcode-block" id="refine_guess"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.refine_guess">[docs]</a><span class="k">def</span> <span class="nf">refine_guess</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">I1</span><span class="p">):</span>
    <span class="n">Imodel</span> <span class="o">=</span> <span class="n">generate_spherical_diffraction</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
    <span class="n">I_adjustment</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">Imodel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">new_I0</span> <span class="o">=</span> <span class="n">I0</span> <span class="o">*</span> <span class="n">I_adjustment</span>
    <span class="c1">#Imodel *= I_adjustment</span>
    <span class="c1">#first_dip_index = np.where(local_minima_detector(Imodel))[0][0]</span>
    <span class="c1">#model_q1 = q[first_dip_index]</span>
    <span class="c1">#model_I1 = I[first_dip_index]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">load_references</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">no_reference_message</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;factorVals&#39;</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;heightFirstDip&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">references</span><span class="p">[</span><span class="s1">&#39;heightAtZero&#39;</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;xFirstDip&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="o">~</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="nb">print</span> <span class="s1">&#39;&#39;&#39;The factorVals entry in the guesser&#39;s reference file is not strictly increasing.</span>
<span class="s1">        This is a serious problem likely to result in horrible crashes and/or incorrect results.&#39;&#39;&#39;</span>
    <span class="n">new_frac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">I1</span><span class="o">/</span><span class="n">new_I0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="c1">#Imodel = generate_spherical_diffraction(q, new_I0, r0, new_frac)</span>
    <span class="c1"># want new r0</span>
    <span class="n">new_x0</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">new_frac</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="n">new_r0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_x0</span><span class="o">/</span><span class="n">q1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_I0</span><span class="p">,</span> <span class="n">new_r0</span><span class="p">,</span> <span class="n">new_frac</span></div>

<div class="viewcode-block" id="take_polydispersity_metrics"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.take_polydispersity_metrics">[docs]</a><span class="k">def</span> <span class="nf">take_polydispersity_metrics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span> <span class="o">=</span> <span class="n">choose_dips_and_shoulders</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">xFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">scaledQuadCoefficients</span> <span class="o">=</span> <span class="n">first_dip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">sigmaScaledFirstDip</span> <span class="o">=</span> <span class="n">polydispersity_metric_sigmaScaledFirstDip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span><span class="p">,</span> <span class="n">xFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">)</span>
    <span class="n">heightAtZero</span> <span class="o">=</span> <span class="n">polydispersity_metric_heightAtZero</span><span class="p">(</span><span class="n">xFirstDip</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sigmaScaledFirstDip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">heightAtZero</span></div>

<div class="viewcode-block" id="choose_dips_and_shoulders"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.choose_dips_and_shoulders">[docs]</a><span class="k">def</span> <span class="nf">choose_dips_and_shoulders</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Find the location of dips (low points) and shoulders (high points).&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">dI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dips</span> <span class="o">=</span> <span class="n">local_minima_detector</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="n">shoulders</span> <span class="o">=</span> <span class="n">local_maxima_detector</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="c1"># Clean out end points and wussy maxima</span>
    <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span> <span class="o">=</span> <span class="n">clean_extrema</span><span class="p">(</span><span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span></div>

<div class="viewcode-block" id="clean_extrema"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.clean_extrema">[docs]</a><span class="k">def</span> <span class="nf">clean_extrema</span><span class="p">(</span><span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># Mark endpoints False</span>
    <span class="n">dips</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dips</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">shoulders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">shoulders</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Reject weaksauce local maxima and minima</span>
    <span class="n">extrema</span> <span class="o">=</span> <span class="n">dips</span> <span class="o">|</span> <span class="n">shoulders</span>
    <span class="n">extrema_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">extrema</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extrema_indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">four_indices</span> <span class="o">=</span> <span class="n">extrema_indices</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">is_dip</span> <span class="o">=</span> <span class="n">dips</span><span class="p">[</span><span class="n">extrema_indices</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">is_dip</span><span class="p">:</span>
            <span class="n">weak</span> <span class="o">=</span> <span class="n">upwards_weaksauce_identifier</span><span class="p">(</span><span class="n">four_indices</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weak</span> <span class="o">=</span> <span class="n">downwards_weaksauce_identifier</span><span class="p">(</span><span class="n">four_indices</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weak</span><span class="p">:</span>
            <span class="n">extrema</span><span class="p">[</span><span class="n">four_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">extrema</span><span class="p">[</span><span class="n">four_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Apply mask to shoulders &amp; dips</span>
    <span class="n">dips</span> <span class="o">=</span> <span class="n">dips</span> <span class="o">*</span> <span class="n">extrema</span>
    <span class="n">shoulders</span> <span class="o">=</span> <span class="n">shoulders</span> <span class="o">*</span> <span class="n">extrema</span>
    <span class="k">return</span> <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span></div>

<div class="viewcode-block" id="upwards_weaksauce_identifier"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.upwards_weaksauce_identifier">[docs]</a><span class="k">def</span> <span class="nf">upwards_weaksauce_identifier</span><span class="p">(</span><span class="n">four_indices</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">four_indices</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">[</span><span class="n">d</span><span class="p">]):</span>
        <span class="n">weak</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weak</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">weak</span></div>

<div class="viewcode-block" id="downwards_weaksauce_identifier"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.downwards_weaksauce_identifier">[docs]</a><span class="k">def</span> <span class="nf">downwards_weaksauce_identifier</span><span class="p">(</span><span class="n">four_indices</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">weak</span> <span class="o">=</span> <span class="n">upwards_weaksauce_identifier</span><span class="p">(</span><span class="n">four_indices</span><span class="p">,</span> <span class="o">-</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weak</span></div>

<div class="viewcode-block" id="guess_size"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.guess_size">[docs]</a><span class="k">def</span> <span class="nf">guess_size</span><span class="p">(</span><span class="n">fractional_variation</span><span class="p">,</span> <span class="n">first_dip_q</span><span class="p">):</span>
<span class="c1">#    global references</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">load_references</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">no_reference_message</span>
    <span class="c1">#xFirstDip, factorVals = references[&#39;xFirstDip&#39;], references[&#39;factorVals&#39;]</span>
    <span class="n">first_dip_x</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">fractional_variation</span><span class="p">,</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;factorVals&#39;</span><span class="p">],</span> <span class="n">references</span><span class="p">[</span><span class="s1">&#39;xFirstDip&#39;</span><span class="p">])</span>
    <span class="n">mean_size</span> <span class="o">=</span> <span class="n">first_dip_x</span> <span class="o">/</span> <span class="n">first_dip_q</span>
    <span class="k">return</span> <span class="n">mean_size</span></div>

<div class="viewcode-block" id="polydispersity_metric_heightAtZero"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.polydispersity_metric_heightAtZero">[docs]</a><span class="k">def</span> <span class="nf">polydispersity_metric_heightAtZero</span><span class="p">(</span><span class="n">qFirstDip</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">qlim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="p">(</span><span class="n">qFirstDip</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">qlim</span> <span class="o">&gt;</span> <span class="mf">0.75</span><span class="o">*</span><span class="n">qFirstDip</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Low-q sampling is poor and will likely affect estimate quality.&quot;</span>
    <span class="n">low_q</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="n">qlim</span><span class="p">)</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">arbitrary_order_solution</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">low_q</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">low_q</span><span class="p">],</span> <span class="n">dI</span><span class="p">[</span><span class="n">low_q</span><span class="p">])</span>
    <span class="n">heightAtZero</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">heightAtZero</span></div>

<div class="viewcode-block" id="first_dip"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.first_dip">[docs]</a><span class="k">def</span> <span class="nf">first_dip</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">dI</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># if the first two &quot;dips&quot; are very close together, they are both marking the first dip</span>
    <span class="c1"># because I can&#39;t eliminate all spurious extrema with such a simple test</span>
    <span class="n">dip_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dips</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Catch the case of operation on noiseless data with few local minima</span>
    <span class="k">if</span> <span class="n">dip_locs</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="s1">&#39;smooth as butter&#39;</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">dip_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">q1</span>
    <span class="c1"># Real data cases</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">dip_locs</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">smult</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="c1"># q1, q2 close compared to q2, q3 and compared to 0, q1</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">q2</span> <span class="o">-</span> <span class="n">q1</span><span class="p">)</span><span class="o">*</span><span class="n">mult</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">q3</span> <span class="o">-</span> <span class="n">q2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">q2</span> <span class="o">-</span> <span class="n">q1</span><span class="p">)</span><span class="o">*</span><span class="n">mult</span> <span class="o">&lt;</span> <span class="n">q1</span><span class="p">):</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s1">&#39;two&#39;</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q3</span>
        <span class="c1"># (q2 - q1)*1.5 approximately equal to q1</span>
        <span class="k">elif</span> <span class="p">((</span><span class="n">q2</span> <span class="o">-</span> <span class="n">q1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span><span class="o">*</span><span class="n">smult</span> <span class="o">&gt;</span> <span class="n">q1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">q2</span> <span class="o">-</span> <span class="n">q1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span> <span class="o">&lt;</span> <span class="n">q1</span><span class="o">*</span><span class="n">smult</span><span class="p">):</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s1">&#39;one&#39;</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s1">&#39;mystery&#39;</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">q1</span>
<span class="c1">#    print &quot;Detected case: %s.&quot; % case</span>
    <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="s1">&#39;two&#39;</span><span class="p">:</span>
        <span class="n">minq</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="n">scale</span><span class="o">*</span><span class="mf">0.1</span>
        <span class="n">maxq</span> <span class="o">=</span> <span class="n">q2</span> <span class="o">+</span> <span class="n">scale</span><span class="o">*</span><span class="mf">0.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minq</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="n">scale</span><span class="o">*</span><span class="mf">0.1</span>
        <span class="n">maxq</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">scale</span><span class="o">*</span><span class="mf">0.1</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="p">((</span><span class="n">q</span> <span class="o">&lt;</span> <span class="n">maxq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">minq</span><span class="p">))</span>
    <span class="c1"># make sure selection is large enough to get a useful sampling</span>
    <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Your sampling in q seems to be sparse and will likely affect the quality of the estimate.&quot;</span>
    <span class="k">while</span> <span class="n">selection</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">selection</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&amp;</span> <span class="n">selection</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">selection</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&amp;</span> <span class="n">selection</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># fit local quadratic</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">arbitrary_order_solution</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">selection</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">selection</span><span class="p">],</span> <span class="n">dI</span><span class="p">[</span><span class="n">selection</span><span class="p">])</span>
    <span class="n">qbest</span> <span class="o">=</span> <span class="n">quadratic_extremum</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>
    <span class="n">Ibest</span> <span class="o">=</span> <span class="n">polynomial_value</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">qbest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qbest</span><span class="p">,</span> <span class="n">Ibest</span><span class="p">,</span> <span class="n">coefficients</span></div>


<div class="viewcode-block" id="polydispersity_metric_sigmaScaledFirstDip"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.polydispersity_metric_sigmaScaledFirstDip">[docs]</a><span class="k">def</span> <span class="nf">polydispersity_metric_sigmaScaledFirstDip</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">shoulders</span><span class="p">,</span> <span class="n">qFirstDip</span><span class="p">,</span> <span class="n">heightFirstDip</span><span class="p">,</span> <span class="n">dI</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">scaled_I</span> <span class="o">=</span> <span class="n">I</span> <span class="o">*</span> <span class="n">q</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">scaled_dI</span> <span class="o">=</span> <span class="n">dI</span> <span class="o">*</span> <span class="n">q</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">powerCoefficients</span> <span class="o">=</span> <span class="n">power_law_solution</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">shoulders</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">shoulders</span><span class="p">],</span> <span class="n">dI</span><span class="p">[</span><span class="n">shoulders</span><span class="p">])</span>
    <span class="n">powerLawAtDip</span> <span class="o">=</span> <span class="n">powerCoefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">qFirstDip</span> <span class="o">**</span> <span class="n">powerCoefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">scaledDipDepth</span> <span class="o">=</span> <span class="p">(</span><span class="n">powerLawAtDip</span> <span class="o">-</span> <span class="n">heightFirstDip</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">qFirstDip</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">firstDipIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dips</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lolim</span> <span class="o">=</span> <span class="n">firstDipIndex</span> <span class="o">-</span> <span class="n">pad</span>
    <span class="n">hilim</span> <span class="o">=</span> <span class="n">firstDipIndex</span> <span class="o">+</span> <span class="n">pad</span>
    <span class="n">quadCoefficients</span> <span class="o">=</span> <span class="n">arbitrary_order_solution</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">],</span> <span class="n">scaled_I</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">],</span> <span class="n">scaled_dI</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">])</span>
    <span class="n">scaledDipCurvature</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">quadCoefficients</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">gauss_guess</span><span class="p">(</span><span class="n">scaledDipDepth</span><span class="p">,</span> <span class="n">scaledDipCurvature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sigma</span></div>

<span class="c1"># Other functions</span>

<div class="viewcode-block" id="gauss_guess"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.gauss_guess">[docs]</a><span class="k">def</span> <span class="nf">gauss_guess</span><span class="p">(</span><span class="n">signalMagnitude</span><span class="p">,</span> <span class="n">signalCurvature</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Guesses a gaussian intensity and width from signal magnitude and curvature.</span>

<span class="sd">    :param signalMagnitude: number-like with units of magnitude</span>
<span class="sd">    :param signalCurvature: number-like with units of magnitude per distance squared</span>
<span class="sd">    :return intensity, sigma:</span>

<span class="sd">    The solution given is not fitted; it is a first estimate to be used in fitting.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">signalMagnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">signalMagnitude</span><span class="p">)</span>
    <span class="n">signalCurvature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">signalCurvature</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">signalMagnitude</span> <span class="o">/</span> <span class="n">signalCurvature</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">signalMagnitude</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">sigma</span></div>

<div class="viewcode-block" id="guess_noise_floor"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.guess_noise_floor">[docs]</a><span class="k">def</span> <span class="nf">guess_noise_floor</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">r0</span><span class="p">):</span>
    <span class="n">qmin</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">qmax</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># we want q &gt;&gt; q1, ideally</span>
    <span class="c1"># the first dip is at 4.5 &lt;~ x &lt;~ 6, where x = q * r0.  We use pessimistic/strict option.</span>
    <span class="n">qscale1</span> <span class="o">=</span> <span class="mi">6</span><span class="o">/</span><span class="n">r0</span>
    <span class="c1"># and we know the worst signal to noise is at high q</span>
    <span class="c1"># so check the last tenth</span>
    <span class="n">qscale2</span> <span class="o">=</span> <span class="n">qmin</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="p">(</span><span class="n">qmax</span> <span class="o">-</span> <span class="n">qmin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">qscale2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">qscale1</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># just a sanity check, no real function</span>
        <span class="nb">print</span> <span class="s2">&quot;Your data do not appear to be sampled to high q.  This is probably not a problem.&quot;</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">qscale2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c1"># making sure there&#39;s a decent number of points in the sample</span>
        <span class="nb">print</span> <span class="s2">&quot;Your data do not appear to be particularly well sampled.  This might be a problem.&quot;</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">selection</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#noise = np.var(I[selection])</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">selection</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">noise</span></div>

<div class="viewcode-block" id="local_maxima_detector"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.local_maxima_detector">[docs]</a><span class="k">def</span> <span class="nf">local_maxima_detector</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds local maxima in ordered data y.</span>

<span class="sd">    :param y: 1d numpy float array</span>
<span class="sd">    :return maxima: 1d numpy bool array</span>

<span class="sd">    *maxima* is *True* at a local maximum, *False* otherwise.</span>

<span class="sd">    This function makes no attempt to reject spurious maxima of various sorts.</span>
<span class="sd">    That task is left to other functions.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span>
    <span class="n">greater_than_follower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">greater_than_leader</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">greater_than_follower</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">greater_than_leader</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">maxima</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">greater_than_follower</span><span class="p">,</span> <span class="n">greater_than_leader</span><span class="p">)</span>
    <span class="c1"># End points</span>
    <span class="n">maxima</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">greater_than_follower</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">maxima</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">greater_than_leader</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">maxima</span></div>

<div class="viewcode-block" id="local_minima_detector"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.local_minima_detector">[docs]</a><span class="k">def</span> <span class="nf">local_minima_detector</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds local minima in ordered data *y*.</span>

<span class="sd">    :param y: 1d numpy float array</span>
<span class="sd">    :return minima: 1d numpy bool array</span>

<span class="sd">    *minima* is *True* at a local minimum, *False* otherwise.</span>

<span class="sd">    This function makes no attempt to reject spurious minima of various sorts.</span>
<span class="sd">    That task is left to other functions.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">minima</span> <span class="o">=</span> <span class="n">local_maxima_detector</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">minima</span></div>

<div class="viewcode-block" id="guess_nearest_point_on_nonmonotonic_trace_normalized"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.guess_nearest_point_on_nonmonotonic_trace_normalized">[docs]</a><span class="k">def</span> <span class="nf">guess_nearest_point_on_nonmonotonic_trace_normalized</span><span class="p">(</span><span class="n">loclist</span><span class="p">,</span> <span class="n">tracelist</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds the nearest point to location *loclist* on a trace *tracelist*.</span>

<span class="sd">    Uses normalized distances, i.e., the significance of each dimension is made equivalent.</span>

<span class="sd">    *loclist* and *tracelist* are lists of the same length and type.</span>
<span class="sd">    Elements of *loclist* are floats; elements of *tracelist* are arrays of the same shape as *coordinate*.</span>
<span class="sd">    *coordinate* is the independent variable along which *tracelist* is varying.</span>

<span class="sd">    *tracelist* must have decent sampling to start with or the algorithm will likely fail.&#39;&#39;&#39;</span>
    <span class="n">tracesize</span> <span class="o">=</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">size</span>
    <span class="n">spacesize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loclist</span><span class="p">)</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tracesize</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spacesize</span><span class="p">):</span>
        <span class="n">yii</span> <span class="o">=</span> <span class="n">tracelist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">meanii</span> <span class="o">=</span> <span class="n">yii</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">varii</span> <span class="o">=</span> <span class="p">(((</span><span class="n">yii</span> <span class="o">-</span> <span class="n">meanii</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">normyii</span> <span class="o">=</span> <span class="p">(</span><span class="n">yii</span> <span class="o">-</span> <span class="n">meanii</span><span class="p">)</span><span class="o">/</span><span class="n">varii</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">loclist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">normy0</span> <span class="o">=</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">meanii</span><span class="p">)</span><span class="o">/</span><span class="n">varii</span>
        <span class="n">diffsquare</span> <span class="o">=</span> <span class="p">(</span><span class="n">normyii</span> <span class="o">-</span> <span class="n">normy0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">+</span> <span class="n">diffsquare</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">best_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">local_minima_detector</span><span class="p">(</span><span class="n">distances</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># At this point we&#39;ve just found good neighborhoods to investigate</span>
    <span class="c1"># So we compare those neighborhoods</span>
    <span class="n">n_candidates</span> <span class="o">=</span> <span class="n">best_indices</span><span class="o">.</span><span class="n">size</span>
    <span class="n">best_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_candidates</span><span class="p">)</span>
    <span class="n">best_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_candidates</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_candidates</span><span class="p">):</span>
        <span class="n">best_index</span> <span class="o">=</span> <span class="n">best_indices</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1"># Assume distances is a fairly (but not perfectly) smooth function of coordinate</span>
        <span class="n">lolim</span> <span class="o">=</span> <span class="n">best_index</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">hilim</span> <span class="o">=</span> <span class="n">best_index</span><span class="o">+</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">lolim</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lolim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">hilim</span> <span class="o">&gt;=</span> <span class="n">tracesize</span><span class="p">:</span>
            <span class="n">hilim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">distance_coefficients</span> <span class="o">=</span> <span class="n">arbitrary_order_solution</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">coordinate</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">],</span><span class="n">distances</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">])</span>
        <span class="n">best_coordinates</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">quadratic_extremum</span><span class="p">(</span><span class="n">distance_coefficients</span><span class="p">)</span>
        <span class="n">best_distances</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">polynomial_value</span><span class="p">(</span><span class="n">distance_coefficients</span><span class="p">,</span> <span class="n">best_coordinates</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
    <span class="c1"># Identify the approximate/probable actual best point...</span>
    <span class="n">best_distance</span> <span class="o">=</span> <span class="n">best_distances</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">best_coordinate</span> <span class="o">=</span> <span class="n">best_coordinates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">best_distances</span> <span class="o">==</span> <span class="n">best_distance</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># ...including the location of that point in space.</span>
    <span class="n">best_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spacesize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spacesize</span><span class="p">):</span>
        <span class="n">coorddiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">best_coordinate</span> <span class="o">-</span> <span class="n">coordinate</span><span class="p">)</span>
        <span class="n">best_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coorddiff</span> <span class="o">==</span> <span class="n">coorddiff</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lolim</span> <span class="o">=</span> <span class="n">best_index</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">hilim</span> <span class="o">=</span> <span class="n">best_index</span><span class="o">+</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">lolim</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lolim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">hilim</span> <span class="o">&gt;=</span> <span class="n">tracesize</span><span class="p">:</span>
            <span class="n">hilim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">xjj</span> <span class="o">=</span> <span class="n">tracelist</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
        <span class="n">xjj_coefficients</span> <span class="o">=</span> <span class="n">arbitrary_order_solution</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">],</span> <span class="n">xjj</span><span class="p">[</span><span class="n">lolim</span><span class="p">:</span><span class="n">hilim</span><span class="p">])</span>
        <span class="n">best_xjj</span> <span class="o">=</span> <span class="n">polynomial_value</span><span class="p">(</span><span class="n">xjj_coefficients</span><span class="p">,</span> <span class="n">best_coordinate</span><span class="p">)</span>
        <span class="n">best_location</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_xjj</span>
    <span class="k">return</span> <span class="n">best_coordinate</span><span class="p">,</span> <span class="n">best_distance</span><span class="p">,</span> <span class="n">best_location</span> <span class="c1">#, distances</span></div>

<div class="viewcode-block" id="chi_squared"><a class="viewcode-back" href="../../../../../../moduledoc_files/paws.core.operations.PROCESSING.SAXS.html#paws.core.operations.PROCESSING.SAXS.saxs.chi_squared">[docs]</a><span class="k">def</span> <span class="nf">chi_squared</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
    <span class="n">bads</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">bads</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">chi_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y1</span><span class="p">[</span><span class="o">~</span><span class="n">bads</span><span class="p">]</span> <span class="o">-</span> <span class="n">y2</span><span class="p">[</span><span class="o">~</span><span class="n">bads</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chi_2</span></div>

<span class="n">no_reference_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;No reference file exists.  Use the GenerateReferences operation once to generate</span>
<span class="s1">an appropriate file; the file will be saved and need not be generated again.&#39;&#39;&#39;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">paws 0.4.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../operations.html" >paws.core.operations</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Lenson A. Pellouchoud.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>